<html>
  <head>
    <LINK rel="stylesheet" href="nesdoc.css" type="text/css" media="screen"><title>Interface: tos.chips.at45db.At45db</title>
  </head>
  <body>
    <h2>Interface: tos.chips.at45db.At45db</h2>
    <b>interface At45db</b><p>
 HAL for Atmel's AT45DB family of serial dataflash chips. This provides
 reasonably high-level operations on AT45DB pages, including automatic
 buffer management. Writes are only guaranteed to happen after a flush,
 flushAll, sync or syncAll.
 <p>
 When buffers are flushed to the flash (either explicitly or implicitly),
 their contents are checked to ensure the write was succesful. If this
 check fails, the flush is retried some number of times. If this fails
 more than some number of times, all access to the flash is disabled
 (all requests will report FAIL in their completion event).
 <p>
 This interface only supports one operation at a time - components offering
 At45db should use the <code>Resource</code> interface for resource sharing.

 
    <p>
    <dl>
      <dt><b>Author:</b>
      <dd>
        David Gay

      </dd>
    </dl>
    <p><p><div id=heading>Commands</div><div id=funcsig><span id=funcnameshort>command void <a href="#computeCrc">computeCrc</a>(at45page_t page, at45pageoffset_t offset, at45pageoffset_t n, uint16_t baseCrc)
      </span><menu>
 Compute the CRC of some data from an AT45DB page (using the CRC
 function from crc.h).
      </menu>
    </div><div id=funcsig><span id=funcnameshort>command void <a href="#copyPage">copyPage</a>(at45page_t from, at45page_t to)
      </span><menu>
 Copy one flash page to another.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>command void <a href="#erase">erase</a>(at45page_t page, uint8_t eraseKind)
      </span><menu>
 Erase an AT45DB page.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>command void <a href="#flush">flush</a>(at45page_t page)
      </span><menu>
 Flush an AT45DB page from the buffers to the actual flash.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>command void <a href="#flushAll">flushAll</a>()
      </span><menu>
 Flush all AT45DB buffers to the actual flash.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>command void <a href="#read">read</a>(at45page_t page, at45pageoffset_t offset, void *data, at45pageoffset_t n)
      </span><menu>
 Read some data from an AT45DB page.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>command void <a href="#sync">sync</a>(at45page_t page)
      </span><menu>
 Flush an AT45DB page from the buffers to the actual flash.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>command void <a href="#syncAll">syncAll</a>()
      </span><menu>
 Flush all AT45DB buffers to the actual flash.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>command void <a href="#write">write</a>(at45page_t page, at45pageoffset_t offset, void *data, at45pageoffset_t n)
      </span><menu>
 Write some data to an AT45DB page.
      </menu>
    </div><p><div id=heading>Events</div><div id=funcsig><span id=funcnameshort>event void <a href="#computeCrcDone">computeCrcDone</a>(error_t error, uint16_t crc)
      </span><menu>
 Signal completion of a CRC computation.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>event void <a href="#copyPageDone">copyPageDone</a>(error_t error)
      </span><menu>
 Signal completion of a copyPage operation.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>event void <a href="#eraseDone">eraseDone</a>(error_t error)
      </span><menu>
 Signal completion of an erase operation.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>event void <a href="#flushDone">flushDone</a>(error_t error)
      </span><menu>
 Signal completion of an flush or flushAll operation.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>event void <a href="#readDone">readDone</a>(error_t error)
      </span><menu>
 Signal completion of a read operation.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>event void <a href="#syncDone">syncDone</a>(error_t error)
      </span><menu>
 Signal completion of a sync or syncAll operation.
      </menu>
    </div><div id=funcsig><span id=funcnameshort>event void <a href="#writeDone">writeDone</a>(error_t error)
      </span><menu>
 Signal completion of a write operation.
      </menu>
    </div><p><div id=heading>Commands - Details</div>
    <a name="computeCrc"></a>
    <h4>computeCrc
    </h4>
    <span id=funcnameshort>command void <b>computeCrc</b>(at45page_t page, at45pageoffset_t offset, at45pageoffset_t n, uint16_t baseCrc)
    </span>
    <p>
    <menu>
      
 Compute the CRC of some data from an AT45DB page (using the CRC
 function from crc.h). computeCrcDone will be signaled.
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>page</code> -  Flash page to read from. Must be less than AT45_MAX_PAGES.
 
        </dd>
        <dd>
          <code>offset</code> -  Offset in page at which to start reading - must be between
   0 and AT45_PAGE_SIZE - 1 
 
        </dd>
        <dd>
          <code>n</code> -  Number of bytes to read (> 0). offset + n must be <= 
   AT45_PAGE_SIZE
 
        </dd>
        <dd>
          <code>baseCrc</code> -  initial CRC value - use 0 if computing a "standalone"
   CRC, or a previous computeCrc result if computing a CRC over several
   flash pages

        </dd>
      </dl>
    </menu>
    <hr>
    <a name="copyPage"></a>
    <h4>copyPage
    </h4>
    <span id=funcnameshort>command void <b>copyPage</b>(at45page_t from, at45page_t to)
    </span>
    <p>
    <menu>
      
 Copy one flash page to another. copyDone will be signaled. If page
 from had been modified, it is first flushed to flash. Page
 <code>to</code> will only actually be written when the buffer holding
 it is flushed (see flush, flushAll, sync, syncAll).

 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>from</code> -  Flash page to copy. Must be less than AT45_MAX_PAGES.
 
        </dd>
        <dd>
          <code>to</code> -  Flash page to overwrite. Must be less than AT45_MAX_PAGES.

        </dd>
      </dl>
    </menu>
    <hr>
    <a name="erase"></a>
    <h4>erase
    </h4>
    <span id=funcnameshort>command void <b>erase</b>(at45page_t page, uint8_t eraseKind)
    </span>
    <p>
    <menu>
      
 Erase an AT45DB page. eraseDone will be signaled.
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>page</code> -  Flash page to erase. Must be less than AT45_MAX_PAGES.
 
        </dd>
        <dd>
          <code>eraseKind</code> -  How to handle the erase:
   <br><code>AT45_ERASE</code>: actually erase the page in the flash chip
   <br><code>AT45_DONT_ERASE</code>: don't erase the page in the flash 
     chip, but reserve a buffer for this page - subsequent writes to this
     page will be faster because the old contents need not be read
   <br><code>AT45_PREVIOUSLY_ERASED</code>: assume the page was previously
     erased in the flash and reserve a buffer for this page - subsequent
     writes to page will be faster because the old contents need not be 
     read and the write itself will be faster

        </dd>
      </dl>
    </menu>
    <hr>
    <a name="flush"></a>
    <h4>flush
    </h4>
    <span id=funcnameshort>command void <b>flush</b>(at45page_t page)
    </span>
    <p>
    <menu>
      
 Flush an AT45DB page from the buffers to the actual flash. flushDone
 will be signaled once the flush has been initiated. If the page is not
 in the buffers, flushDone will succeed "immediately".
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>page</code> -  Flash page to sync. Must be less than AT45_MAX_PAGES.

        </dd>
      </dl>
    </menu>
    <hr>
    <a name="flushAll"></a>
    <h4>flushAll
    </h4>
    <span id=funcnameshort>command void <b>flushAll</b>()
    </span>
    <p>
    <menu>
      
 Flush all AT45DB buffers to the actual flash. flushDone
 will be signaled once the flushes have been initiated. 

    </menu>
    <hr>
    <a name="read"></a>
    <h4>read
    </h4>
    <span id=funcnameshort>command void <b>read</b>(at45page_t page, at45pageoffset_t offset, void *data, at45pageoffset_t n)
    </span>
    <p>
    <menu>
      
 Read some data from an AT45DB page. readDone will be signaled.
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>page</code> -  Flash page to read from. Must be less than AT45_MAX_PAGES.
 
        </dd>
        <dd>
          <code>offset</code> -  Offset in page at which to start reading - must be between
   0 and AT45_PAGE_SIZE - 1 
 
        </dd>
        <dd>
          <code>data</code> -  Buffer in which to place read data. The buffer is "returned"
   at readDone time.
 
        </dd>
        <dd>
          <code>n</code> -  Number of bytes to read (> 0). offset + n must be <= 
   AT45_PAGE_SIZE

        </dd>
      </dl>
    </menu>
    <hr>
    <a name="sync"></a>
    <h4>sync
    </h4>
    <span id=funcnameshort>command void <b>sync</b>(at45page_t page)
    </span>
    <p>
    <menu>
      
 Flush an AT45DB page from the buffers to the actual flash. syncDone
 will be signaled once the flush has been completed and the buffer 
 contents successfully compared with the flash. If the page is not
 in the buffers, syncDone will succeed "immediately".
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>page</code> -  Flash page to sync. Must be less than AT45_MAX_PAGES.

        </dd>
      </dl>
    </menu>
    <hr>
    <a name="syncAll"></a>
    <h4>syncAll
    </h4>
    <span id=funcnameshort>command void <b>syncAll</b>()
    </span>
    <p>
    <menu>
      
 Flush all AT45DB buffers to the actual flash. syncDone
 will be signaled once the flush has been completed and the buffer 
 contents successfully compared with the flash. 

    </menu>
    <hr>
    <a name="write"></a>
    <h4>write
    </h4>
    <span id=funcnameshort>command void <b>write</b>(at45page_t page, at45pageoffset_t offset, void *data, at45pageoffset_t n)
    </span>
    <p>
    <menu>
      
 Write some data to an AT45DB page. writeDone will be signaled.
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>page</code> -  Flash page to write to. Must be less than AT45_MAX_PAGES.
 
        </dd>
        <dd>
          <code>offset</code> -  Offset in page at which to start writing - must be between
   0 and AT45_PAGE_SIZE - 1 
 
        </dd>
        <dd>
          <code>data</code> -  Data to write. The buffer is "returned" at writeDone time.
 
        </dd>
        <dd>
          <code>n</code> -  Number of bytes to write (> 0). offset + n must be <= 
   AT45_PAGE_SIZE

        </dd>
      </dl>
    </menu>
    <p><div id=heading>Events - Details</div>
    <a name="computeCrcDone"></a>
    <h4>computeCrcDone
    </h4>
    <span id=funcnameshort>event void <b>computeCrcDone</b>(error_t error, uint16_t crc)
    </span>
    <p>
    <menu>
      
 Signal completion of a CRC computation.
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>error</code> -  SUCCESS if the CRC was successfully computed, FAIL otherwise
 
        </dd>
        <dd>
          <code>crc</code> -  CRC value (valid only if error == SUCCESS)

        </dd>
      </dl>
    </menu>
    <hr>
    <a name="copyPageDone"></a>
    <h4>copyPageDone
    </h4>
    <span id=funcnameshort>event void <b>copyPageDone</b>(error_t error)
    </span>
    <p>
    <menu>
      
 Signal completion of a copyPage operation. 
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>error</code> -  SUCCESS if the copy was successful, FAIL otherwise

        </dd>
      </dl>
    </menu>
    <hr>
    <a name="eraseDone"></a>
    <h4>eraseDone
    </h4>
    <span id=funcnameshort>event void <b>eraseDone</b>(error_t error)
    </span>
    <p>
    <menu>
      
 Signal completion of an erase operation. 
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>error</code> -  SUCCESS if the erase was successful, FAIL otherwise

        </dd>
      </dl>
    </menu>
    <hr>
    <a name="flushDone"></a>
    <h4>flushDone
    </h4>
    <span id=funcnameshort>event void <b>flushDone</b>(error_t error)
    </span>
    <p>
    <menu>
      
 Signal completion of an flush or flushAll operation. 
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>error</code> -  SUCCESS if the flush was successful, FAIL otherwise

        </dd>
      </dl>
    </menu>
    <hr>
    <a name="readDone"></a>
    <h4>readDone
    </h4>
    <span id=funcnameshort>event void <b>readDone</b>(error_t error)
    </span>
    <p>
    <menu>
      
 Signal completion of a read operation. The buffer passed to read
 is implictly returned.
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>error</code> -  SUCCESS for a successful read, FAIL otherwise

        </dd>
      </dl>
    </menu>
    <hr>
    <a name="syncDone"></a>
    <h4>syncDone
    </h4>
    <span id=funcnameshort>event void <b>syncDone</b>(error_t error)
    </span>
    <p>
    <menu>
      
 Signal completion of a sync or syncAll operation. 
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>error</code> -  SUCCESS if the sync was successful, FAIL otherwise

        </dd>
      </dl>
    </menu>
    <hr>
    <a name="writeDone"></a>
    <h4>writeDone
    </h4>
    <span id=funcnameshort>event void <b>writeDone</b>(error_t error)
    </span>
    <p>
    <menu>
      
 Signal completion of a write operation. The buffer passed to write
 is implictly returned.
 
      <p>
      <dl>
        <dt><b>Parameters:</b>
        <dd>
          <code>error</code> -  SUCCESS for a successful write, FAIL otherwise

        </dd>
      </dl>
    </menu>
  </body>
</html>
